name: Deploy to Namecheap

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      build_sha: ${{ steps.meta.outputs.build_sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run -s typecheck

      - name: Lint
        run: npm run -s lint

      - name: Build project
        run: npm run build

      - name: Export build metadata
        id: meta
        run: echo "build_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist
          retention-days: 5

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist

      - name: List artifact contents
        run: |
          echo "Dist directory listing:";
          ls -al dist
      - name: Preflight DNS & connectivity check
        id: preflight
        run: |
          HOST="${{ secrets.FTP_SERVER }}"
          echo "Checking DNS resolution for $HOST";
          if command -v dig >/dev/null 2>&1; then
            dig +short "$HOST" || true
          fi
          getent hosts "$HOST" || true
          echo "Attempting TCP connection tests (ports 21 FTP, 990 FTPS implicit, 22 SFTP)";
          for PORT in 21 990 22; do
            (echo > /dev/tcp/$HOST/$PORT) >/dev/null 2>&1 && echo "Port $PORT: OPEN" || echo "Port $PORT: closed or filtered";
          done
          RESOLVED_IP=$(getent hosts "$HOST" | awk '{print $1}' | head -n1)
          if [ -z "$RESOLVED_IP" ]; then
            echo "::error title=DNS resolution failed::Host '$HOST' did not resolve. Verify secrets.FTP_SERVER matches your cPanel Server Name or a valid hostname (e.g. serverXX.web-hosting.com) or add an A record for a custom subdomain (ftp.yourdomain).";
            exit 1
          fi
          echo "Resolved IP: $RESOLVED_IP"
          echo "resolved_ip=$RESOLVED_IP" >> $GITHUB_OUTPUT
      - name: Advice if FTP fails
        if: always()
        run: |
          echo "If the upcoming FTP step fails with ENOTFOUND again:"
          echo "1. Re-check secret FTP_SERVER (current resolves to: ${{ steps.preflight.outputs.resolved_ip || 'UNRESOLVED' }})"
          echo "2. Try protocol 'sftp' (preferred) by changing protocol: sftp in workflow."
          echo "3. For Namecheap shared hosting you can find Server Name in cPanel > General Information. Use that as FTP_SERVER."
          echo "4. Ensure any firewall or FTP access restrictions are disabled or allow GitHub Actions (GitHub outbound IP ranges)."
      - name: Deploy via FTP to Namecheap
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /public_html/
          local-dir: dist/
          protocol: ftps
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**

      - name: Record deploy timestamp
        run: echo "deployed_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

  verify:
    name: Verify
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Verify root page
        run: |
          curl -I https://${{ secrets.DEPLOY_DOMAIN }}/ || exit 1
      - name: Verify privacy page
        run: |
          curl -I https://${{ secrets.DEPLOY_DOMAIN }}/privacy || exit 1
      - name: Verify account deletion page
        run: |
          curl -I https://${{ secrets.DEPLOY_DOMAIN }}/account-deletion || exit 1
      - name: Summary
        run: |
          echo "Build SHA: ${{ needs.build.outputs.build_sha }}";
          echo "Deployment verified for ${{ secrets.DEPLOY_DOMAIN }}";
          echo "Timestamp: ${{ env.deployed_at }}"
